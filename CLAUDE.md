# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **kite-swing-scan** project - a Python-based stock scanner for NSE (National Stock Exchange) equities that identifies swing trading opportunities using technical analysis. The scanner uses Zerodha's Kite Connect API to fetch historical data and ranks stocks based on trend + consolidation patterns.

## Core Architecture

### Main Components

1. **Scanner Engine** (`src/scan.py`) - Main scanning logic that:
   - Processes NIFTY-500 universe of stocks
   - Fetches historical OHLCV data via Kite API
   - Applies technical filters (trend, consolidation, volume, ATR)
   - Ranks candidates using weighted scoring model
   - Outputs ranked results to CSV files

2. **Kite API Client** (`src/kite_client.py`) - Handles:
   - Kite Connect API authentication and session management
   - Historical data fetching with local CSV caching for performance
   - NSE instruments master data retrieval

3. **Technical Analysis** (`src/screener.py`) - Technical indicators:
   - Moving averages, ATR (Average True Range)
   - Trend detection (50/200 MA crossover)
   - Pattern detection (NR7, Inside Day)
   - Box consolidation analysis

4. **Authentication Server** (`src/auth_server.py`) - Flask server for Kite Connect OAuth flow
5. **Site Publisher** (`src/publish_site.py`) - Generates static HTML site from scan results
6. **Universe Updater** (`scripts/update_universe.py`) - Downloads latest NIFTY-500 constituents

### Data Flow

```
NIFTY-500 symbols → Kite API → Historical Data → Technical Analysis → Scoring → Ranked Output → HTML Site
```

### File Structure

- `src/` - Core Python modules
  - `scan.py` - Main scanner with database storage
  - `kite_client.py` - Kite API client with caching
  - `screener.py` - Technical analysis functions
  - `database.py` - SQLite database operations
  - `api_server.py` - REST API server for data access
  - `auth_server.py` - OAuth authentication server
  - `publish_site.py` - Enhanced HTML site generator
- `data/` - Universe files and SQLite database
  - `universe_nifty500.txt` - Stock symbols list
  - `stock_data.db` - SQLite database with OHLC data
- `cache/` - Local CSV cache for historical data (per symbol)
- `out/YYYY-MM-DD/` - Daily scan results
- `site/` - Generated HTML output with interactive features
- `tokens.json` - Kite Connect API tokens (generated by auth flow)
- `.env` - API credentials (KITE_API_KEY, KITE_API_SECRET)

## Common Commands

### Setup & Authentication
```bash
# Install dependencies (manually check imports in source files)
pip install pandas numpy kiteconnect flask python-dotenv requests flask-cors sqlite3

# Update NIFTY-500 universe
python scripts/update_universe.py

# Start auth server for Kite Connect login (first time setup)
python src/auth_server.py
# Then visit http://localhost:5000 to complete OAuth flow
```

### Running Scans
```bash
# Run daily scan (main command) - now stores data in SQLite database
python src/scan.py

# Publish results to HTML site (enhanced with interactive features)
python src/publish_site.py

# Start API server for historical data access
python src/api_server.py
# Server runs on http://127.0.0.1:8000
```

### Environment Configuration
The scanner behavior is controlled via environment variables (see `src/scan.py` lines 35-56):
- `UNIVERSE_PATH` - Universe file path (default: data/universe_nifty500.txt)
- `PRICE_FLOOR` - Minimum stock price filter (default: ₹100)
- `MIN_DV_CR` - Minimum 20D avg traded value in crores (default: 5.0)
- `BOX_LEN`, `BOX_SPAN` - Consolidation box parameters
- Scoring weights: `W_BOX`, `W_ATR`, `W_VOL`, `W_PIVOT`

## Key Dependencies

- `kiteconnect` - Zerodha Kite Connect API client
- `pandas` - Data analysis and CSV handling
- `numpy` - Numerical computations for technical indicators
- `flask` - OAuth authentication server
- `python-dotenv` - Environment variable management
- `requests` - HTTP client for downloading universe data

## Authentication & Tokens

The project uses Kite Connect API which requires:
1. API credentials in `.env` file
2. Daily authentication via OAuth flow (generates `tokens.json`)
3. Access tokens expire daily and need refresh

## Database Schema

The SQLite database (`data/stock_data.db`) contains:

### `daily_ohlc` table
- `symbol` - Stock trading symbol
- `date` - Trading date (YYYY-MM-DD)
- `open`, `high`, `low`, `close` - Price data
- `volume` - Trading volume
- `traded_value` - Close price × volume

### `scan_results` table
- `scan_date` - Date of scan run
- `total_symbols`, `ranked_symbols` - Scan statistics
- `scan_duration_seconds` - Performance metrics

## API Endpoints

The API server (`src/api_server.py`) provides:

- `GET /api/dates` - List available dates
- `GET /api/data/<date>` - All OHLC data for date
- `GET /api/summary/<date>` - Daily summary statistics
- `GET /api/symbol/<symbol>` - Historical data for symbol
- `GET /api/symbols/<date>` - Available symbols for date
- `GET /api/search?q=<query>` - Search symbols
- `GET /api/bulk/<date>?symbols=<list>` - Bulk data retrieval

## Frontend Features

The enhanced HTML site now includes:

- **Date Picker** - Browse historical data by date
- **View Modes** - Switch between scan results and OHLC data
- **Symbol Search** - Filter stocks by symbol name
- **Interactive Tables** - Clickable symbols with detail modals
- **Summary Statistics** - Daily market overview
- **Historical Analysis** - Individual symbol history

## Output Files

- `out/YYYY-MM-DD/todays_scan.csv` - Ranked scan results
- `out/YYYY-MM-DD/debug_checks.csv` - Debug info and filtered stocks
- `site/index.html` - Enhanced interactive HTML report
- `site/data/latest.csv` - Latest scan results for download
- `site/archive/YYYY-MM-DD.csv` - Historical scan archive
- `data/stock_data.db` - SQLite database with complete OHLC history